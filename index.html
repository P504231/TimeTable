<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Planner & Progress Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
body {
    background: linear-gradient(135deg, #81c784 0%, #2e7d32 100%);
    color: #263238;
    line-height: 1.6;
    padding: 20px;
    min-height: 100vh;
    overflow-x: hidden;
}
.container {
    max-width: 1200px;
    margin: 0 auto;
}
header {
    text-align: center;
    margin-bottom: 30px;
    padding: 25px;
    background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
    color: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(46, 125, 50, 0.15);
}
h1 {
    font-size: 2.8rem;
    margin-bottom: 15px;
    letter-spacing: 0.5px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
}
.date-range {
    font-size: 1.3rem;
    font-weight: 500;
    opacity: 0.9;
}
.current-task-container {
    background: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    font-weight: 500;
    color: #2c3e50;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    text-align: center;
}
.current-task-container .task-label {
    font-size: 1.2rem;
    font-weight: bold;
    color: #FF0000;
    text-transform: uppercase;
    letter-spacing: 1px;
}
.current-task-container .animated-arrow {
    font-size: 1.8rem;
    color: #8B0000;
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.2); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
}
.current-task-container .task-name {
    font-size: 2.4rem;
    font-weight: bold;
    color: #FF0000;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}
.digital-stopwatch {
    font-family: 'Courier New', monospace;
    font-size: 1.8rem;
    font-weight: bold;
    color: #1b5e20;
    background: #c8e6c9;
    padding: 10px 20px;
    border-radius: 10px;
    border: 2px solid #e9ecef;
    min-width: 140px;
    text-align: center;
    animation: blink 1s step-end infinite;
}
@keyframes blink {
    50% { opacity: 0.7; }
}
.day-navigation {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 25px;
    flex-wrap: wrap;
}
.day-btn {
    padding: 12px 22px;
    background: #388e3c;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    box-shadow: 0 4px 8px rgba(46, 125, 50, 0.2);
}
.day-btn:hover {
    background: #2e7d32;
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(46, 125, 50, 0.3);
}
.day-btn.active {
    background: #81c784;
    color: #1b5e20;
    box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.15);
}
.tables-container {
    display: flex;
    gap: 25px;
    flex-wrap: wrap;
}
.daily-table-container { flex: 2; min-width: 300px; }
.overview-table-container { flex: 1; min-width: 300px; }
table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 25px;
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
}
th, td {
    padding: 15px 18px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
}
th {
    background: linear-gradient(135deg, #388e3c 0%, #2e7d32 100%);
    color: white;
    font-weight: 600;
    font-size: 1.1rem;
}
tr:nth-child(even) { background-color: #f3fbf5; }
tr:hover { background-color: #e8f5e9; }
tr.completed {
    background-color: #d0f8ce !important;
    color: #155724;
}
.start-btn, .stop-btn {
    padding: 8px 16px;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    margin-left: 10px;
    font-weight: 600;
}
.start-btn {
    background: #388e3c;
}
.start-btn:hover {
    background: #2e7d32;
}
.start-btn:disabled {
    background: #cccccc;
    cursor: not-allowed;
}
.stop-btn {
    background: #d32f2f;
}
.stop-btn:hover {
    background: #b71c1c;
}
.timer-display {
    font-weight: bold;
    color: #388e3c;
    display: inline-block;
    min-width: 80px;
    text-align: right;
}
.timer-container {
    display: flex;
    align-items: center;
    justify-content: flex-start;
}
.done-cell {
    text-align: center;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}
.award-btn {
    background: #81c784;
    color: #1b5e20;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
}
.award-btn:hover {
    background: #388e3c;
    color: white;
    transform: scale(1.1);
}
.toggle-container {
    display: flex;
    justify-content: center;
    margin: 25px 0;
    gap: 15px;
}
.toggle-btn {
    padding: 12px 25px;
    background: #388e3c;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 8px rgba(46, 125, 50, 0.2);
}
.toggle-btn:hover {
    background: #2e7d32;
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(46, 125, 50, 0.3);
}
.date-display {
    margin: 10px 0;
    font-size: 1.2rem;
    font-weight: 500;
    color: #2c3e50;
}
.progress-bar {
    width: 100%;
    height: 20px;
    background: #c8e6c9;
    border-radius: 10px;
    overflow: hidden;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #388e3c, #81c784);
    transition: width 0.3s ease;
}
.celebration {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 1000;
    pointer-events: none;
}
.celebration-message {
    font-size: 3rem;
    font-weight: bold;
    color: #388e3c;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    margin-bottom: 20px;
    animation: zoom 2s ease-out;
}
@keyframes zoom {
    0% { transform: scale(0.5); opacity: 0; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}
.firework {
    position: absolute;
    border-radius: 50%;
    animation: explode 1s ease-out forwards;
}
@keyframes explode {
    0% { transform: scale(0); opacity: 1; }
    100% { transform: scale(2); opacity: 0; }
}
@media (max-width: 768px) {
    .tables-container { flex-direction: column; }
    .day-navigation { justify-content: flex-start; }
    h1 { font-size: 2.2rem; }
    .timer-display { min-width: 60px; }
    .start-btn, .stop-btn { margin-left: 5px; }
    .current-task-container { padding: 20px; }
    .current-task-container .task-label { font-size: 1rem; }
    .current-task-container .animated-arrow { font-size: 1.5rem; }
    .current-task-container .task-name { font-size: 2rem; }
    .digital-stopwatch { font-size: 1.5rem; }
}
@media (max-width: 480px) {
    .current-task-container .task-label { font-size: 0.8rem; }
    .current-task-container .animated-arrow { font-size: 1.2rem; }
    .current-task-container .task-name { font-size: 1.6rem; }
    .digital-stopwatch { font-size: 1.2rem; min-width: 100px; padding: 8px 15px; }
}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Intense Revision Plan</h1>
            <div class="date-range">September 21 - 26, 2025</div>
        </header>
        <div class="current-task-container" id="current-task">
            <div>No task currently active</div>
        </div>
        <div class="day-navigation" id="day-navigation"></div>
        <div class="toggle-container">
            <button class="toggle-btn" id="toggle-view">Show Overall Performance</button>
        </div>
        <div class="tables-container">
            <div class="daily-table-container">
                <h2>Daily Study Schedule - <span id="current-day">Day 1</span></h2>
                <div class="date-display" id="current-date">September 14, 2025</div>
                <table id="daily-table">
                    <thead>
                        <tr>
                            <th>Activity</th>
                            <th>Timer</th>
                            <th>Done</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="overview-table-container" id="overview-container" style="display: none;">
                <h2>Day Overview</h2>
                <table id="overview-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Completed</th>
                            <th>Progress</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        const studyPlan = {
            days: [],
            currentDay: 1,
            showOverview: false,
            activeTaskIndex: null,
            activeTaskDay: null,
            timerInterval: null
        };

        // Task definitions for September 21-30, 2025
           const TASKS = [
            { activity: 'English FRB', duration: 3600000 }, // 1 hours = 2*60*60*1000 ms
            { activity: 'Computer', duration: 1800000 }, // 0.5 hours = 30*60*1000 ms
            { activity: 'GS Paper-1 PYQ', duration: 14400000 } // 4 hours = 4*60*60*1000 ms
        ];

        // Helper to create task objects
        const createTask = ({ activity, duration }) => ({
            activity,
            duration,
            done: false,
            startTime: null,
            elapsedTime: 0,
            remainingTime: duration,
            timerInterval: null,
            isPaused: false
        });

        // Initialize study plan with tasks for September 21-30, 2025
        function initializeStudyPlan() {
            studyPlan.days = [];
            const startDate = new Date(2025, 8, 21); // September 21, 2025
            for (let i = 0; i < 11; i++) {
                const dayDate = new Date(startDate);
                dayDate.setDate(startDate.getDate() + i);
                dayDate.setHours(0, 0, 0, 0);
                const formattedDate = formatDate(dayDate);
                const tasks = TASKS.map(createTask);

                studyPlan.days.push({
                    dayNumber: i + 1,
                    date: dayDate,
                    formattedDate,
                    tasks
                });
            }
        }

        // Format date to "Month Day, Year"
        function formatDate(date) {
            if (!(date instanceof Date) || isNaN(date)) {
                console.error('Invalid date:', date);
                return 'Unknown Date';
            }
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
        }

        // Format time to HH:MM:SS
        function formatTime(ms) {
            if (ms <= 0) return '00:00:00';
            const totalSeconds = Math.floor(ms / 1000);
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        // Format time to MM:SS
        function formatTimeShort(ms) {
            if (ms <= 0) return '00:00';
            const totalSeconds = Math.floor(ms / 1000);
            const m = Math.floor(totalSeconds / 60);
            const s = totalSeconds % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        // Check if a date is today
        function isToday(dayDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (!(dayDate instanceof Date) || isNaN(dayDate)) return false;
            const checkDate = new Date(dayDate);
            checkDate.setHours(0, 0, 0, 0);
            return checkDate.getTime() === today.getTime();
        }

        // Update current task display
        function updateCurrentTaskDisplay() {
            const currentTaskDiv = document.getElementById('current-task');
            if (studyPlan.activeTaskIndex === null || studyPlan.activeTaskDay === null) {
                currentTaskDiv.innerHTML = '<div>No task currently active</div>';
                if (studyPlan.timerInterval) {
                    cancelAnimationFrame(studyPlan.timerInterval);
                    studyPlan.timerInterval = null;
                }
                return;
            }

            const day = studyPlan.days[studyPlan.activeTaskDay - 1];
            const task = day.tasks[studyPlan.activeTaskIndex];
            const remaining = task.remainingTime;

            const update = () => {
                if (!task.isPaused) {
                    const updatedRemaining = task.duration - (task.elapsedTime + (Date.now() - task.startTime));
                    if (updatedRemaining <= 0) {
                        completeTask(studyPlan.activeTaskIndex);
                        return;
                    }
                    task.remainingTime = updatedRemaining;
                }
                currentTaskDiv.innerHTML = `
                    <div>
                        <div><span class="task-label">Currently Studying</span></div>
                        <div><span class="animated-arrow">➔</span><span class="task-name">${task.activity}</span></div>
                        <div><span class="digital-stopwatch">${formatTime(task.remainingTime)}</span></div>
                    </div>
                `;
                saveToLocalStorage();
                if (studyPlan.activeTaskIndex !== null && !task.isPaused) {
                    studyPlan.timerInterval = requestAnimationFrame(update);
                }
            };

            if (!studyPlan.timerInterval && !task.isPaused) {
                studyPlan.timerInterval = requestAnimationFrame(update);
            } else if (task.isPaused) {
                update(); // Update display without starting animation
            }
        }

        // Generate day navigation buttons
        function generateDayNavigation() {
            const nav = document.getElementById('day-navigation');
            nav.innerHTML = studyPlan.days.map((day, index) => `
                <button class="day-btn ${studyPlan.currentDay === index + 1 ? 'active' : ''}" data-day="${index + 1}">
                    ${day.formattedDate.split(' ')[0]} ${day.formattedDate.split(' ')[1].replace(',', '')}
                </button>
            `).join('');
            nav.querySelectorAll('.day-btn').forEach(btn =>
                btn.addEventListener('click', () => switchDay(parseInt(btn.dataset.day)))
            );
        }

        // Switch to a specific day
        function switchDay(day) {
            try {
                studyPlan.currentDay = day;
                document.querySelectorAll('.day-btn').forEach(btn =>
                    btn.classList.toggle('active', parseInt(btn.dataset.day) === day)
                );
                document.getElementById('current-day').textContent = `Day ${day}`;
                document.getElementById('current-date').textContent = studyPlan.days[day - 1]?.formattedDate || 'Unknown Date';
                renderDailyTable();
                updateCurrentTaskDisplay();
                saveToLocalStorage();
            } catch (error) {
                console.error('Error in switchDay:', error);
            }
        }

        // Render daily task table
        function renderDailyTable() {
            try {
                const tbody = document.querySelector('#daily-table tbody');
                const day = studyPlan.days[studyPlan.currentDay - 1];
                if (!day || !day.tasks) {
                    tbody.innerHTML = '<tr><td colspan="3">No tasks available</td></tr>';
                    return;
                }
                const isCurrentDay = isToday(day.date);
                tbody.innerHTML = day.tasks.map((task, index) => {
                    const isRunning = studyPlan.activeTaskIndex === index && studyPlan.activeTaskDay === studyPlan.currentDay && !task.isPaused;
                    return `
                        <tr class="${task.done ? 'completed' : ''}">
                            <td>${task.activity}</td>
                            <td class="timer-cell" data-index="${index}">
                                ${task.done ? 'Completed' : isCurrentDay ? `
                                    <div class="timer-container">
                                        <span class="timer-display" data-index="${index}">${formatTimeShort(task.remainingTime)}</span>
                                        ${isRunning ? 
                                            `<button class="stop-btn" data-index="${index}">Stop</button>` :
                                            `<button class="start-btn" data-index="${index}" ${studyPlan.activeTaskIndex !== null && !isRunning && studyPlan.activeTaskDay !== studyPlan.currentDay ? 'disabled' : ''}>${task.isPaused ? 'Resume' : 'Start'}</button>`}
                                    </div>
                                ` : 'Not Started'}
                            </td>
                            <td class="done-cell">
                                ${task.done ? `✔️ <button class="award-btn" data-index="${index}" title="Celebrate completion">🏆</button>` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');

                tbody.querySelectorAll('.start-btn').forEach(btn =>
                    btn.addEventListener('click', () => handleStart(parseInt(btn.dataset.index)))
                );
                tbody.querySelectorAll('.stop-btn').forEach(btn =>
                    btn.addEventListener('click', () => handleStop(parseInt(btn.dataset.index)))
                );
                tbody.querySelectorAll('.award-btn').forEach(btn =>
                    btn.addEventListener('click', () => celebrateCompletion())
                );
            } catch (error) {
                console.error('Error in renderDailyTable:', error);
                document.querySelector('#daily-table tbody').innerHTML = '<tr><td colspan="3">Error loading tasks</td></tr>';
            }
        }

        // Start a task
        function handleStart(index) {
            try {
                if (studyPlan.activeTaskIndex !== null && studyPlan.activeTaskDay !== studyPlan.currentDay) return;
                const day = studyPlan.days[studyPlan.currentDay - 1];
                const task = day.tasks[index];
                if (task.done) return;
                if (!task.startTime) {
                    task.startTime = Date.now();
                    task.remainingTime = task.duration;
                } else if (task.isPaused) {
                    task.startTime = Date.now();
                    task.isPaused = false;
                }
                studyPlan.activeTaskIndex = index;
                studyPlan.activeTaskDay = studyPlan.currentDay;
                startTimer(index);
                renderDailyTable();
                updateCurrentTaskDisplay();
                saveToLocalStorage();
            } catch (error) {
                console.error('Error in handleStart:', error);
            }
        }

        // Stop a task
        function handleStop(index) {
            try {
                const day = studyPlan.days[studyPlan.activeTaskDay - 1];
                const task = day.tasks[index];
                if (task.timerInterval) {
                    clearInterval(task.timerInterval);
                    task.timerInterval = null;
                }
                task.elapsedTime += Date.now() - task.startTime;
                task.remainingTime = task.duration - task.elapsedTime;
                task.isPaused = true;
                if (task.remainingTime <= 0) {
                    completeTask(index);
                } else {
                    studyPlan.timerInterval = null;
                    renderDailyTable();
                    updateCurrentTaskDisplay();
                    saveToLocalStorage();
                }
            } catch (error) {
                console.error('Error in handleStop:', error);
            }
        }

        // Start task timer
        function startTimer(index) {
            try {
                const day = studyPlan.days[studyPlan.activeTaskDay - 1];
                const task = day.tasks[index];
                if (task.timerInterval) clearInterval(task.timerInterval);
                task.timerInterval = setInterval(() => {
                    const elapsed = task.elapsedTime + (Date.now() - task.startTime);
                    const remaining = task.duration - elapsed;
                    if (remaining <= 0) {
                        clearInterval(task.timerInterval);
                        task.timerInterval = null;
                        completeTask(index);
                    } else {
                        task.remainingTime = remaining;
                        updateTimerUI(index, remaining);
                        saveToLocalStorage();
                    }
                }, 1000);
            } catch (error) {
                console.error('Error in startTimer:', error);
            }
        }

        // Update timer UI
        function updateTimerUI(index, remaining) {
            try {
                if (studyPlan.currentDay === studyPlan.activeTaskDay) {
                    const display = document.querySelector(`.timer-display[data-index="${index}"]`);
                    if (display) display.textContent = formatTimeShort(remaining);
                }
            } catch (error) {
                console.error('Error in updateTimerUI:', error);
            }
        }

        // Complete a task
        function completeTask(index) {
            try {
                const day = studyPlan.days[studyPlan.activeTaskDay - 1];
                const task = day.tasks[index];
                if (task.timerInterval) {
                    clearInterval(task.timerInterval);
                    task.timerInterval = null;
                }
                task.done = true;
                task.startTime = null;
                task.elapsedTime = 0;
                task.remainingTime = task.duration;
                task.isPaused = false;
                studyPlan.activeTaskIndex = null;
                studyPlan.activeTaskDay = null;
                if (studyPlan.timerInterval) {
                    cancelAnimationFrame(studyPlan.timerInterval);
                    studyPlan.timerInterval = null;
                }
                renderDailyTable();
                updateCurrentTaskDisplay();
                saveToLocalStorage();
            } catch (error) {
                console.error('Error in completeTask:', error);
            }
        }

        // Show celebration animation
        function celebrateCompletion() {
            const celebration = document.createElement('div');
            celebration.className = 'celebration';
            celebration.innerHTML = '<div class="celebration-message">Well Done 👏</div>';
            document.body.appendChild(celebration);

            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const firework = document.createElement('div');
                    firework.className = 'firework';
                    firework.style.left = Math.random() * 100 + 'vw';
                    firework.style.top = Math.random() * 100 + 'vh';
                    firework.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    firework.style.width = (Math.random() * 20 + 10) + 'px';
                    firework.style.height = firework.style.width;
                    celebration.appendChild(firework);
                    setTimeout(() => firework.remove(), 1000);
                }, i * 50);
            }

            setTimeout(() => celebration.remove(), 2000);
        }

        // Render overview table
        function renderOverviewTable() {
            try {
                const tbody = document.querySelector('#overview-table tbody');
                tbody.innerHTML = studyPlan.days.map(day => {
                    const completed = day.tasks.filter(t => t.done).length;
                    const total = day.tasks.length;
                    const percentage = Math.round((completed / total) * 100);
                    return `
                        <tr>
                            <td>${day.formattedDate}</td>
                            <td>${completed}/${total}</td>
                            <td><div class="progress-bar"><div class="progress-fill" style="width:${percentage}%"></div></div></td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error in renderOverviewTable:', error);
            }
        }

        // Toggle between daily and overview views
        function toggleView() {
            try {
                studyPlan.showOverview = !studyPlan.showOverview;
                document.querySelector('.daily-table-container').style.display = studyPlan.showOverview ? 'none' : 'block';
                document.getElementById('overview-container').style.display = studyPlan.showOverview ? 'block' : 'none';
                document.getElementById('toggle-view').textContent = studyPlan.showOverview ? 'Show Daily Schedule' : 'Show Overall Performance';
                if (studyPlan.showOverview) renderOverviewTable();
                saveToLocalStorage();
            } catch (error) {
                console.error('Error in toggleView:', error);
            }
        }

        // Save study plan to local storage
        function saveToLocalStorage() {
            try {
                const serializablePlan = {
                    ...studyPlan,
                    timerInterval: null,
                    days: studyPlan.days.map(day => ({
                        ...day,
                        date: day.date.toISOString(),
                        tasks: day.tasks.map(task => ({
                            ...task,
                            startTime: task.startTime ? task.startTime.toISOString() : null,
                            timerInterval: null
                        }))
                    }))
                };
                localStorage.setItem('studyPlan', JSON.stringify(serializablePlan));
            } catch (error) {
                console.error('Error in saveToLocalStorage:', error);
            }
        }

        // Load study plan from local storage with improved validation
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('studyPlan');
                if (!savedData) {
                    console.log('No localStorage data found, initializing new study plan');
                    initializeStudyPlan();
                    return;
                }

                const parsedData = JSON.parse(savedData);
                const expectedStartDate = new Date(2025, 8, 14);
                expectedStartDate.setHours(0, 0, 0, 0);

                // Validate structure and date range
                if (!parsedData.days) {
                    console.warn('Invalid localStorage: Missing days array');
                    localStorage.removeItem('studyPlan');
                    initializeStudyPlan();
                    return;
                }
                if (parsedData.days.length !== 4) {
                    console.warn(`Invalid localStorage: Expected 4 days, found ${parsedData.days.length}`);
                    localStorage.removeItem('studyPlan');
                    initializeStudyPlan();
                    return;
                }
                if (!parsedData.days[0].date) {
                    console.warn('Invalid localStorage: Missing date for first day');
                    localStorage.removeItem('studyPlan');
                    initializeStudyPlan();
                    return;
                }

                const firstDayDate = new Date(parsedData.days[0].date);
                firstDayDate.setHours(0, 0, 0, 0);
                if (firstDayDate.getTime() !== expectedStartDate.getTime()) {
                    console.warn(`Invalid localStorage: Expected start date September 14, 2025, found ${formatDate(firstDayDate)}`);
                    localStorage.removeItem('studyPlan');
                    initializeStudyPlan();
                    return;
                }

                // Validate task structure for each day
                const expectedTaskCount = TASKS.length;
                const expectedTaskNames = TASKS.map(t => t.activity);
                for (let i = 0; i < parsedData.days.length; i++) {
                    const day = parsedData.days[i];
                    if (!day.tasks || day.tasks.length !== expectedTaskCount) {
                        console.warn(`Invalid localStorage: Day ${i + 1} has ${day.tasks ? day.tasks.length : 0} tasks, expected ${expectedTaskCount}`);
                        localStorage.removeItem('studyPlan');
                        initializeStudyPlan();
                        return;
                    }
                    const taskNames = day.tasks.map(t => t.activity);
                    if (!expectedTaskNames.every((name, idx) => name === taskNames[idx])) {
                        console.warn(`Invalid localStorage: Day ${i + 1} tasks do not match expected activities`);
                        localStorage.removeItem('studyPlan');
                        initializeStudyPlan();
                        return;
                    }
                }

                // Data is valid, load it
                studyPlan.days = parsedData.days.map(day => ({
                    ...day,
                    date: new Date(day.date),
                    tasks: day.tasks.map(task => ({
                        ...task,
                        startTime: task.startTime ? new Date(task.startTime) : null,
                        remainingTime: task.remainingTime || task.duration,
                        timerInterval: null
                    }))
                }));
                studyPlan.currentDay = parsedData.currentDay || 1;
                studyPlan.showOverview = parsedData.showOverview || false;
                studyPlan.activeTaskIndex = parsedData.activeTaskIndex;
                studyPlan.activeTaskDay = parsedData.activeTaskDay;

                // Validate and resume active task
                if (studyPlan.activeTaskIndex !== null && studyPlan.activeTaskDay !== null) {
                    const task = studyPlan.days[studyPlan.activeTaskDay - 1]?.tasks[studyPlan.activeTaskIndex];
                    if (task && task.startTime && task.remainingTime > 0 && !task.done && !task.isPaused) {
                        startTimer(studyPlan.activeTaskIndex);
                    } else {
                        console.warn('Invalid active task in localStorage, clearing active task');
                        studyPlan.activeTaskIndex = null;
                        studyPlan.activeTaskDay = null;
                    }
                }

                console.log('Successfully loaded study plan from localStorage');
            } catch (error) {
                console.error('Error in loadFromLocalStorage:', error.message, error.stack);
                localStorage.removeItem('studyPlan');
                initializeStudyPlan();
            }
        }

        // Initialize the app
        function initApp() {
            try {
                loadFromLocalStorage();
                generateDayNavigation();
                switchDay(studyPlan.currentDay);
                if (studyPlan.showOverview) toggleView();
                document.getElementById('toggle-view').addEventListener('click', toggleView);
                updateCurrentTaskDisplay();
            } catch (error) {
                console.error('Error in initApp:', error.message, error.stack);
                document.querySelector('#daily-table tbody').innerHTML = '<tr><td colspan="3">Error initializing app</td></tr>';
            }
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
